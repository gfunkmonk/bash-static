name: bsd

on: workflow_dispatch

jobs:
  netbsd-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        include:
          - arch: x86_64
            netbsd_version: '10.0'
    steps:
      - uses: actions/checkout@v6
      - name: Build bash natively on NetBSD
        uses: cross-platform-actions/action@v0.27.0
        with:
          operating_system: netbsd
          version: ${{ matrix.netbsd_version }}
          shell: bash
          run: |
            sudo pkgin -y update
            sudo pkgin -y install autoconf gnupg2 curl mozilla-rootcerts upx coreutils
            # Configure GPG to reach keyservers from inside the QEMU VM
            #mkdir -p ~/.gnupg && chmod 700 ~/.gnupg
            #echo "keyserver hkps://keys.openpgp.org" > ~/.gnupg/gpg.conf
            #echo "keyserver hkps://keyserver.ubuntu.com" >> ~/.gnupg/gpg.conf
            ./build.sh netbsd ${{ matrix.arch }} --nosig
      - name: rename artifact
        run: |
          cd releases
          BASH_FILE=$(ls bash* | head -n 1)
          mv -v "$BASH_FILE" bash-NetBSD-${{ matrix.arch }}
      - uses: actions/upload-artifact@v6
        with:
          name: bash-NetBSD-${{ matrix.arch }}
          path: releases/bash-NetBSD-${{ matrix.arch }}
  freebsd-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        include:
          - arch: x86_64
            freebsd_version: '14.2'
    steps:
      - uses: actions/checkout@v6
      - name: Build bash natively on FreeBSD
        uses: cross-platform-actions/action@v0.27.0
        with:
          operating_system: freebsd
          version: ${{ matrix.freebsd_version }}
          shell: bash
          run: |
            sudo pkg install -y autoconf gnupg curl
            # Configure GPG to reach keyservers from inside the QEMU VM
            #mkdir -p ~/.gnupg && chmod 700 ~/.gnupg
            #echo "keyserver hkps://keys.openpgp.org" > ~/.gnupg/gpg.conf
            #echo "keyserver hkps://keyserver.ubuntu.com" >> ~/.gnupg/gpg.conf
            ./build.sh freebsd ${{ matrix.arch }} --nosig
      - name: rename artifact
        run: |
          cd releases
          BASH_FILE=$(ls bash* | head -n 1)
          mv -v "$BASH_FILE" bash-FreeBSD-${{ matrix.arch }}
      - uses: actions/upload-artifact@v6
        with:
          name: bash-FreeBSD-${{ matrix.arch }}
          path: releases/bash-FreeBSD-${{ matrix.arch }}
  openbsd-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        include:
          - arch: x86_64
            openbsd_version: '7.8'
    steps:
      - uses: actions/checkout@v6
      - name: Build bash natively on OpenBSD
        uses: cross-platform-actions/action@v0.32.0
        with:
          operating_system: openbsd
          version: ${{ matrix.openbsd_version }}
          shell: bash
          run: |
            sudo pkg_add autoconf-2.72p0 gnupg curl
            # Configure GPG to reach keyservers from inside the QEMU VM
            #mkdir -p ~/.gnupg && chmod 700 ~/.gnupg
            #echo "keyserver hkps://keys.openpgp.org" > ~/.gnupg/gpg.conf
            #echo "keyserver hkps://keyserver.ubuntu.com" >> ~/.gnupg/gpg.conf
            AUTOCONF_VERSION=2.72 ./build.sh openbsd ${{ matrix.arch }} --nosig
      - name: rename artifact
        run: |
          cd releases
          BASH_FILE=$(ls bash* | head -n 1)
          mv -v "$BASH_FILE" bash-OpenBSD-${{ matrix.arch }}
      #- name: Run UPX
      #  uses: crazy-max/ghaction-upx@v3
      #  with:
      #    version: latest
      #    files: |
      #      ./releases/bash-OpenBSD-${{ matrix.arch }}
      #    args: --ultra-brute
      - uses: actions/upload-artifact@v6
        with:
          name: bash-OpenBSD-${{ matrix.arch }}
          path: releases/bash-OpenBSD-${{ matrix.arch }}